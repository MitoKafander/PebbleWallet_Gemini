<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gemini Wallet Config</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bwip-js/3.4.3/bwip-js-min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 15px; background: #f2f2f7; color: #1c1c1e; }
        .card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        input, select { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #e5e5ea; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #f2f2f7; }
        button { width: 100%; padding: 14px; background: #007aff; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        button.remove { background: #ff3b30; width: auto; padding: 8px 12px; font-size: 14px; margin-top: 0; }
        button.add { background: #34c759; margin-bottom: 30px; }
        .btn-tiny { width: 30px; padding: 4px; font-size: 12px; background: #8e8e93; display: inline-block; margin-top: 0; }
        .btn-tiny:disabled { opacity: 0.3; }
        .order-btns { display: flex; align-items: center; }
        .preview-canvas { display: none; }
        .settings-row { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        label { font-weight: 600; }
    </style>
</head>
<body>
    <h2>App Settings</h2>
    <div class="settings-row">
        <label>Invert Colors (High Contrast)</label>
        <input type="checkbox" id="invert-toggle" style="transform: scale(1.2)" onchange="updateInvert(this.checked)">
    </div>

    <h2>My Wallet</h2>
    <div id="cards-container"></div>
    <button class="add" onclick="addCard()">+ Add Card</button>
    <button onclick="save()">Save & Sync to Watch</button>
    
    <canvas id="render-canvas" class="preview-canvas"></canvas>

    <script>
        var FORMATS = [
            {id: 0, name: "Code 128", bwip: "code128"},
            {id: 1, name: "Code 39", bwip: "code39"},
            {id: 2, name: "EAN-13", bwip: "ean13"},
            {id: 3, name: "QR Code", bwip: "qrcode"},
            {id: 4, name: "Aztec Code", bwip: "azteccode"},
            {id: 5, name: "PDF417", bwip: "pdf417"}
        ];

        var cards = [];
        var invert = false;

        // Load Initial State
        try {
            var hash = window.location.hash.substring(1);
            if(hash) {
                var data = JSON.parse(decodeURIComponent(hash));
                cards = data.cards || [];
                invert = data.invert || false;
            }
        } catch(e) {}

        document.getElementById('invert-toggle').checked = invert;
        function updateInvert(val) { invert = val; }

        function render() {
            var container = document.getElementById('cards-container');
            container.innerHTML = '';
            cards.forEach(function(card, idx) {
                var el = document.createElement('div');
                el.className = 'card';
                var opts = FORMATS.map(f => `<option value="${f.id}" ${card.format==f.id?'selected':''}>${f.name}</option>`).join('');
                
                // CRITICAL FIX: Always show card.text (raw input) in the UI
                // Never show the encoded card.data
                var displayVal = card.text || card.data || "";
                if (displayVal.indexOf(',') > -1 && displayVal.length > 30) displayVal = ""; 

                el.innerHTML = `
                    <div class="card-header">
                        <div class="order-btns">
                            <button class="btn-tiny" onclick="move(${idx}, -1)" ${idx==0?'disabled':''}>↑</button>
                            <button class="btn-tiny" onclick="move(${idx}, 1)" ${idx==cards.length-1?'disabled':''}>↓</button>
                            <strong style="margin-left:5px">Card ${idx+1}</strong>
                        </div>
                        <button class="remove" onclick="remove(${idx})">Remove</button>
                    </div>
                    <input type="text" placeholder="Card Name" value="${card.name || ''}" onchange="update(${idx}, 'name', this.value)">
                    <input type="text" placeholder="Description" value="${card.description || ''}" onchange="update(${idx}, 'description', this.value)">
                    <select onchange="update(${idx}, 'format', this.value)">${opts}</select>
                    <input type="text" placeholder="Data (Number or Text)" value="${displayVal}" onchange="update(${idx}, 'text', this.value)">
                `;
                container.appendChild(el);
            });
        }

        function update(idx, field, val) { 
            cards[idx][field] = val; 
            if(field === 'text') cards[idx].data = ""; // Clear old matrix if text changes
        }
        function move(idx, dir) {
            var target = idx + dir;
            if (target < 0 || target >= cards.length) return;
            var temp = cards[idx]; cards[idx] = cards[target]; cards[target] = temp;
            render();
        }
        function addCard() { cards.push({name:'', text:'', format:0}); render(); }
        function remove(idx) { cards.splice(idx, 1); render(); }
        
        function generateMatrixData(text, formatId) {
            return new Promise((resolve, reject) => {
                var canvas = document.getElementById('render-canvas');
                var bwipId = FORMATS.find(f => f.id == formatId).bwip;
                try {
                    var options = { bcid: bwipId, text: text, scale: 1, includetext: false, paddingwidth: 0, paddingheight: 0 };
                    if (formatId == 4) { options.format = 'compact'; options.layers = 1; } 
                    else if (formatId == 5) { options.columns = 2; options.eclevel = 1; }
                    else if (formatId < 3) { options.height = 10; }

                    bwipjs.toCanvas(canvas, options);
                    
                    var w = canvas.width, h = canvas.height;
                    var pixels = canvas.getContext('2d').getImageData(0, 0, w, h).data;
                    var hex = "", val = 0, bitCount = 0;
                    for(var r=0; r<h; r++) {
                        for(var c=0; c<w; c++) {
                            var idx = (r*w + c) * 4;
                            var isBlack = (pixels[idx+3] > 128) && (pixels[idx] < 128); 
                            val = (val << 1) | (isBlack ? 1 : 0);
                            if(++bitCount == 4) { hex += val.toString(16).toUpperCase(); val = 0; bitCount = 0; }
                        }
                    }
                    if(bitCount > 0) { val = val << (4 - bitCount); hex += val.toString(16).toUpperCase(); }
                    resolve(`${w},${h},${hex}`);
                } catch (e) { reject(e); }
            });
        }

        async function save() {
            var btn = document.querySelector('button[onclick="save()"]');
            btn.innerText = "Syncing..."; btn.disabled = true;

            for(let c of cards) {
                var input = c.text || c.data;
                if(!c.name || !input) continue;
                // If input doesn't look like matrix data, encode it
                if(input.indexOf(',') === -1) {
                    try {
                        c.text = input; // Keep the original
                        c.data = await generateMatrixData(input, c.format);
                    } catch(e) {
                        alert(`Error: ${e}`); btn.innerText = "Save & Sync"; btn.disabled = false; return;
                    }
                }
            }
            location.href = 'pebblejs://close#' + encodeURIComponent(JSON.stringify({invert: invert, cards: cards}));
        }
        render();
    </script>
</body>
</html>