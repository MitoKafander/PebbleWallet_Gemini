<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gemini Wallet Config</title>
    <!-- Import bwip-js for barcode generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bwip-js/3.4.3/bwip-js-min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 15px; background: #f2f2f7; color: #1c1c1e; }
        .card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        input, select { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #e5e5ea; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #f2f2f7; }
        button { width: 100%; padding: 14px; background: #007aff; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        button.remove { background: #ff3b30; width: auto; padding: 8px 12px; font-size: 14px; margin-top: 0; }
        button.add { background: #34c759; margin-bottom: 30px; }
        .btn-tiny { width: 30px; padding: 4px; font-size: 12px; background: #8e8e93; display: inline-block; margin-top: 0; }
        .btn-tiny:disabled { opacity: 0.3; }
        .order-btns { display: flex; align-items: center; }
        .preview-canvas { display: none; }
        .hint { font-size: 12px; color: #8e8e93; margin-top: -5px; margin-bottom: 10px; }
        .settings-row { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        label { font-weight: 600; }
        .toggle { transform: scale(1.2); }
    </style>
</head>
<body>
    <h2>App Settings</h2>
    <div class="settings-row">
        <label>Invert Colors (High Contrast)</label>
        <input type="checkbox" id="invert-toggle" class="toggle" onchange="updateInvert(this.checked)">
    </div>

    <h2>My Wallet</h2>
    <div id="cards-container"></div>
    <button class="add" onclick="addCard()">+ Add Card</button>
    <button onclick="save()">Save & Sync to Watch</button>
    
    <canvas id="render-canvas" class="preview-canvas"></canvas>

    <script>
        var FORMATS = [
            {id: 0, name: "Code 128", bwip: "code128"},
            {id: 1, name: "Code 39", bwip: "code39"},
            {id: 2, name: "EAN-13", bwip: "ean13"},
            {id: 3, name: "QR Code", bwip: "qrcode"},
            {id: 4, name: "Aztec Code", bwip: "azteccode"},
            {id: 5, name: "PDF417", bwip: "pdf417"}
        ];

        var cards = [];
        var invert = false;

        try {
            var hash = window.location.hash.substring(1);
            if(hash) {
                var data = JSON.parse(decodeURIComponent(hash));
                // Handle new data structure (object with invert + cards) vs old (just cards)
                if (data.cards) {
                    cards = data.cards;
                    invert = data.invert || false;
                } else {
                    cards = data;
                }
            }
        } catch(e) {}

        document.getElementById('invert-toggle').checked = invert;

        function updateInvert(val) { invert = val; }

        function render() {
            var container = document.getElementById('cards-container');
            container.innerHTML = '';
            cards.forEach(function(card, idx) {
                var el = document.createElement('div');
                el.className = 'card';
                var opts = FORMATS.map(f => `<option value="${f.id}" ${card.format==f.id?'selected':''}>${f.name}</option>`).join('');
                
                var displayData = card.data;
                if ((card.format == 4 || card.format == 5) && card.data.indexOf(',') > -1) {
                     if(card.data.length > 50) displayData = "(Encoded Matrix Data)";
                }

                el.innerHTML = `
                    <div class="card-header">
                        <div class="order-btns">
                            <button class="btn-tiny" onclick="move(${idx}, -1)" ${idx==0?'disabled':''}>↑</button>
                            <button class="btn-tiny" onclick="move(${idx}, 1)" ${idx==cards.length-1?'disabled':''}>↓</button>
                            <strong style="margin-left:5px">Card ${idx+1}</strong>
                        </div>
                        <button class="remove" onclick="remove(${idx})">Remove</button>
                    </div>
                    <input type="text" placeholder="Card Name" value="${card.name || ''}" onchange="update(${idx}, 'name', this.value)">
                    <input type="text" placeholder="Description" value="${card.description || ''}" onchange="update(${idx}, 'description', this.value)">
                    <select onchange="update(${idx}, 'format', this.value)">${opts}</select>
                    <input type="text" placeholder="Data" value="${displayData}" onchange="update(${idx}, 'data', this.value)">
                `;
                container.appendChild(el);
            });
        }

        function update(idx, field, val) { cards[idx][field] = val; }
        function move(idx, dir) {
            var target = idx + dir;
            if (target < 0 || target >= cards.length) return;
            var temp = cards[idx]; cards[idx] = cards[target]; cards[target] = temp;
            render();
        }
        function addCard() { cards.push({name:'', data:'', format:0}); render(); }
        function remove(idx) { cards.splice(idx, 1); render(); }
        
        function generateMatrixData(text, formatId) {
            return new Promise((resolve, reject) => {
                var canvas = document.getElementById('render-canvas');
                var bwipId = FORMATS.find(f => f.id == formatId).bwip;
                
                try {
                    var options = {
                        bcid: bwipId,
                        text: text,
                        scale: 1,
                        includetext: false,
                        paddingwidth: 0,
                        paddingheight: 0,
                    };

                    if (formatId == 3) { } 
                    else if (formatId == 4) { 
                        // Aztec Optimization: Force COMPACT format and minimum layers
                        options.format = 'compact';
                        options.layers = 1;
                    } 
                    else if (formatId == 5) { options.columns = 2; options.eclevel = 1; }
                    else { options.height = 10; }

                    try {
                        bwipjs.toCanvas(canvas, options);
                    } catch (optErr) {
                        bwipjs.toCanvas(canvas, { bcid: bwipId, text: text, scale: 1, includetext: false });
                    }
                    
                    var w = canvas.width;
                    var h = canvas.height;
                    var ctx = canvas.getContext('2d');
                    var imgData = ctx.getImageData(0, 0, w, h);
                    var pixels = imgData.data;
                    var hex = "";
                    var val = 0;
                    var bitCount = 0;
                    
                    for(var r=0; r<h; r++) {
                        for(var c=0; c<w; c++) {
                            var idx = (r*w + c) * 4;
                            var isBlack = (pixels[idx+3] > 128) && (pixels[idx] < 128); 
                            val = (val << 1) | (isBlack ? 1 : 0);
                            bitCount++;
                            if(bitCount == 4) {
                                hex += val.toString(16).toUpperCase();
                                val = 0;
                                bitCount = 0;
                            }
                        }
                    }
                    if(bitCount > 0) {
                        val = val << (4 - bitCount);
                        hex += val.toString(16).toUpperCase();
                    }
                    resolve(`${w},${h},${hex}`);
                } catch (e) { reject(e); }
            });
        }

        async function save() {
            var btn = document.querySelector('button[onclick="save()"]');
            btn.innerText = "Syncing...";
            btn.disabled = true;

            var finalCards = [];
            for(let c of cards) {
                if(!c.name || !c.data) continue;
                let processedCard = { ...c };
                if (c.format >= 0) {
                    try {
                        processedCard.data = await generateMatrixData(c.data, c.format);
                    } catch(e) {
                        alert(`Error encoding ${c.name}: ${e}`);
                        btn.innerText = "Save & Sync";
                        btn.disabled = false;
                        return;
                    }
                }
                finalCards.push(processedCard);
            }

            var result = {
                invert: invert,
                cards: finalCards
            };
            location.href = 'pebblejs://close#' + encodeURIComponent(JSON.stringify(result));
        }

        render();
    </script>
</body>
</html>
